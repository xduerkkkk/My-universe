**上下文 (Context)**

一个线程的**上下文**，是指操作系统为了在未来某个时刻能够**暂停并完美地恢复 (Pause and Resume)** 该线程的执行所需要保存的**全部状态信息的集合**。

这个集合，被精确地分为三个层次：

- **a. 硬件上下文 (Hardware Context)**
    
    - **定义**：指当前正保存在**CPU物理寄存器中**的、与该线程直接相关的所有信息。
        
    - **包含**：
        
        - **程序计数器 (Program Counter, PC)**：指向下一条即将执行的指令的内存地址。
            
        - **通用目的寄存器 (General-Purpose Registers)**：如 EAX, EBX 等，用于存放计算过程中的操作数和中间结果。
            
        - **栈指针寄存器 (Stack Pointer)**：指向当前线程的调用栈的栈顶。
            
        - **程序状态字 (Processor Status Word, PSW)**：包含CPU的当前状态，如条件码、中断启用/禁用标志等。
            
    - **特点**：这是**最直接、最底层**的上下文。CPU的执行，就是靠这套寄存器驱动的。
        
- **b. 用户空间上下文 (User-space Context)**
    
    - **定义**：指线程在执行过程中，在其**用户态**内存空间里存放的数据。
        
    - **包含**：
        
        - **程序代码段**
            
        - **数据段** (全局变量、静态变量)
            
        - **用户栈** (函数参数、局部变量、返回地址)
            
        - **堆** (动态分配的内存)
            
    - **特点**：这部分信息**通常不**在上下文切换时被“保存”，因为它们本来就安稳地存放在内存里。它们属于进程的“地址空间”。
        
- **c. 内核空间上下文 (Kernel-space Context)**
    
    - **定义**：操作系统内核为了管理该线程而维护的相关数据结构。
        
    - **包含**：
        
        - **线程控制块 (TCB)**：这是保存**硬件上下文副本**的地方。
            
        - **内核栈**：线程在执行系统调用时，在内核态使用的栈。
            
        - **进程控制块 (PCB) 的指针**：指明该线程属于哪个进程。
            
        - 与该线程相关的**内核数据结构**：比如该线程打开了哪些文件、占用了哪些内核资源等。
            

**2. 上下文切换 (Context Switch)**

**定义**：是一个由**操作系统内核**主导的过程，它**保存**当前CPU上正在运行的线程的**硬件上下文**，然后**加载**另一个线程的**硬件上下文**到CPU寄存器中，从而改变CPU的执行流。

**精确流程：**

- **线程A -> 线程B**
    
    1. **中断/系统调用**：一个外部事件触发切换。
        
    2. CPU从**用户态**切换到**内核态**。
        
    3. **保存A的硬件上下文**：内核执行指令，将CPU当前的所有寄存器（PC, GPRs, SP等）的值，**复制**到内存中线程A的TCB里。
        
    4. **调度**：内核的调度算法选择线程B作为下一个运行目标。
        
    5. **加载B的硬件上下文**：内核执行指令，从内存中线程B的TCB里，**读取**之前保存的寄存器值，并将它们**复制**回CPU的物理寄存器中。
        
    6. CPU从**内核态**切换回**用户态**（如果B是在用户态运行）。
        
    7. **执行恢复**：CPU的PC寄存器现在指向了B上次中断的位置，于是CPU开始执行B的代码。