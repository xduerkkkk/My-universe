### **直觉构建】**

这个问题，我们之前在讨论文件系统全局结构时，已经把它“人格化”了：**“土地规划局的沙盘”**。

它的核心任务只有一个：**快速、准确地**回答两个问题：

1. “请给我找一块（或N块）**空闲的**地皮（磁盘块）。”
    
2. “这块地皮（磁盘块）我现在不用了，请**回收**并标记为空闲。”
    

物业公司（文件系统）有两种主流的“沙盘”管理技术：

**1. 位图 (Bitmap / Bit Vector)**

- **比喻**：一张巨大的**“座位表”**。
    
    - 整个硬盘有多少个数据块，这张座位表上就有多少个“座位”（二进制位）。
        
    - 每个座位只有两种状态：1 (已占用) 或 0 (空闲)。
        
- **如何工作**：
    
    - **分配**：需要一个空闲块时，就从头到尾扫描这张表，找到第一个为0的位置，把它改成1，然后把对应的块号返回。
        
    - **回收**：释放一个块时，直接把对应位置的位，从1改成0。
        
- **优点**：
    
    - **简单直观**。
        
    - 可以很**容易地**找到**连续的**空闲块（只需要在位图中寻找一串连续的0）。
        
- **缺点**：
    
    - **空间开销**：对于一个大硬盘，这张“座位表”本身可能会占用不小的空间。比如，一个1TB的硬盘，如果以4KB为块大小，大约有2.5亿个块，那么位图本身就需要 2.5亿 bit ≈ 30 MB 的空间。
        

**2. 链表 (Linked List)**

- **比喻**：一种**“寻宝游戏”**。
    
    - 你不需要一张完整的地图。你只需要知道**第一个**空闲块的**位置**。
        
    - 在这个空闲块的**内部**，存放着一个“指针”，指向**下一个**空闲块的位置。
        
    - 所有的空闲块，就这样一个接一个地被串成了一条长链。
        
- **如何工作**：
    
    - **分配**：需要一个空闲块时，直接从链表的“头部”取下一个块即可。非常快。
        
    - **回收**：把释放的块，加到链表的头部。也非常快。
        
- **优点**：
    
    - **分配和回收操作极快**（如果只操作头部）。
        
    - **没有独立的、大的空间开销**（指针信息存放在空闲块自身内部）。
        
- **缺点**：
    
    - **难以找到连续的空闲块**。你需要遍历链表，并检查每个块的物理位置是否连续，效率很低。
        

**衍生策略**：还有一些结合两者优点的策略，比如**成组链接 (Grouping)**，即链表的每个节点里，不仅有下一个节点的指针，还记录了一小组（比如100个）连续的空闲块号。

---

### **【精度校准】**

- **位图 (Bitmap)**：用一个二进制位序列表示磁盘块的分配状态。0代表空闲，1代表已分配。
    
- **空闲链表 (Free List)**：将所有空闲的磁盘块通过指针链接起来。
    
- **权衡**：位图便于查找连续的空闲空间，但有额外空间开销。链表在分配/回收单个块时非常高效，但查找连续空间困难。现代文件系统常使用位图或其变体。